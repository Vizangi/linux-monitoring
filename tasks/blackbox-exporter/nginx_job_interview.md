# Как вы использовали Nginx на практике, для каких команд устанавливали и какие кейсы с ним были?

---

### 1. **Как Nginx использовался в вашей работе?**

**Пример ответа:**
"Nginx использовался для решения множества задач: от обслуживания статического контента до балансировки нагрузки и работы в качестве обратного прокси. Мы настраивали его для раздачи файлов, перенаправления запросов к приложениям, защиты от DDoS-атак и кэширования ответов. Эти конфигурации позволяли нам обеспечивать высокую производительность, отказоустойчивость и безопасность наших сервисов."

---

### 2. **Какие команды вы использовали для работы с Nginx?**

#### Установка Nginx:
```bash
sudo apt update
sudo apt install nginx -y
```
**Я устанавливал Nginx через пакетный менеджер (например, `apt` для Ubuntu). После установки проверял его работу с помощью команд:**

```bash
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### Проверка конфигурации:
```bash
sudo nginx -t
```
**Для проверки корректности конфигурации я использовал команду `nginx -t`. Она помогала выявить ошибки перед перезапуском сервера.**

#### Перезапуск Nginx:
```bash
sudo systemctl reload nginx
```
**После внесения изменений в конфигурацию я перезагружал Nginx с помощью `systemctl reload nginx`, чтобы применить изменения без простоя.**

#### Просмотр логов:
```bash
tail -f /var/log/nginx/error.log
tail -f /var/log/nginx/access.log
```
**Для диагностики проблем я анализировал логи доступа (`access.log`) и ошибок (`error.log`).**

---

### 3. **Кому вы устанавливали Nginx?**

**Пример ответа:**
"Я устанавливал Nginx на:

- **Серверы приложений**: для работы в качестве обратного прокси или балансировщика нагрузки.
- **Веб-серверы**: для раздачи статического контента и обслуживания сайтов.
- **Команды DevOps/SRE**: для настройки отказоустойчивости и мониторинга.
- **Команды разработчиков**: для тестирования и интеграции их приложений с Nginx."

---

### 4. **Какие каверзные вопросы могут возникнуть и как на них ответить?**

#### Вопрос: Как вы решали проблемы с производительностью Nginx?
**Ответ:**
"Если возникали проблемы с производительностью, я:

1. Оптимизировал параметры Nginx, такие как `worker_processes`, `worker_connections` и `multi_accept`.
2. Включал gzip-сжатие и кэширование для уменьшения времени загрузки.
3. Анализировал логи и метрики (например, количество активных подключений) для выявления узких мест."

#### Вопрос: Как вы обеспечивали безопасность Nginx?
**Ответ:**
"Я:

1. Настроил HTTPS с использованием Let's Encrypt для шифрования трафика.
2. Ограничивал доступ к чувствительным эндпоинтам через `allow`/`deny` или basic auth.
3. Защищал от DDoS-атак с помощью модулей `limit_req` и `limit_conn`."

#### Вопрос: Как вы решали проблему с большим количеством подключений?
**Ответ:**
"Если количество подключений было слишком большим, я:

1. Увеличивал лимиты на подключения (`worker_connections`).
2. Настраивал таймауты (`keepalive_timeout`, `client_body_timeout`) для освобождения ресурсов.
3. Использовал upstream-пулы для распределения нагрузки между несколькими серверами."

#### Вопрос: Как вы настраивали мониторинг Nginx?
**Ответ:**
"Я добавлял модуль `stub_status` для сбора базовой статистики и интегрировал Nginx Exporter с Prometheus для детального мониторинга. Также создавал дашборды в Grafana для визуализации метрик."

---

### 5. **Пример успешного кейса использования Nginx**

**Пример ответа:**
"Однажды мы столкнулись с проблемой высокой нагрузки на наш веб-сервер из-за большого количества одновременных подключений. С помощью Nginx мы настроили балансировку нагрузки между несколькими серверами приложений. Мы также включили кэширование и gzip-сжатие, что позволило значительно уменьшить нагрузку на бэкенд и время отклика для пользователей."

---

### 6. **Что ещё можно добавить?**

#### Интеграция с Prometheus и Grafana:
"Мы интегрировали Nginx с Prometheus через Nginx Exporter для сбора метрик и с Grafana для визуализации. Это позволило нам создавать информативные дашборды с данными о производительности серверов Nginx."

#### Автоматизация установки:
"Для масштабирования я написал Ansible playbook для автоматической установки и настройки Nginx. Это упростило развертывание на нескольких серверах."

#### Мониторинг бизнес-метрик:
"Мы использовали Nginx для мониторинга ключевых бизнес-метрик, таких как количество HTTP-ошибок (например, 4xx и 5xx статусы) и среднее время обработки запросов."

#### Защита от DDoS-атак:
"Мы настраивали Nginx для защиты от DDoS-атак с помощью ограничения скорости запросов (`limit_req`) и блокировки подозрительных IP-адресов через `deny`."

---

## Как вы использовали Nginx Exporter на практике, для каких команд устанавливали и какие кейсы с ним были?

---

### 1. **Как Nginx Exporter использовался в вашей работе?**

**Пример ответа:**
"Nginx Exporter использовался для мониторинга состояния веб-серверов Nginx. Мы собирали метрики, такие как количество активных подключений (`nginx_connections_active`), общее количество обработанных запросов (`nginx_requests_total`), скорость обработки запросов и статус HTTP-ответов. Эти данные интегрировались с Prometheus для анализа и с Grafana для визуализации. Это позволяло нам отслеживать производительность серверов Nginx, выявлять проблемы с нагрузкой и оперативно реагировать на инциденты."

---

### 2. **Какие команды вы использовали для работы с Nginx Exporter?**

#### Установка Nginx Exporter:
```bash
wget https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v0.12.0/nginx-prometheus-exporter_0.12.0_linux_amd64.tar.gz
tar xvfz nginx-prometheus-exporter_0.12.0_linux_amd64.tar.gz
./nginx-prometheus-exporter -nginx.scrape-uri=http://localhost/nginx_status
```
**Я устанавливал Nginx Exporter через скачивание бинарного файла с GitHub. Запускал его с флагами для настройки URL сбора метрик (например, `/nginx_status`) и указания порта для экспортера.**

#### Проверка работы Nginx Exporter:
```bash
curl http://localhost:9113/metrics
```
**Для проверки работы я использовал curl, чтобы получить метрики из `/metrics`. Это помогало убедиться, что экспортер корректно собирает данные.**

#### Настройка автозапуска через systemd:
```ini
[Unit]
Description=Nginx Exporter

[Service]
ExecStart=/usr/local/bin/nginx-prometheus-exporter -nginx.scrape-uri=http://localhost/nginx_status
Restart=always

[Install]
WantedBy=multi-user.target
```
**Для автоматического запуска я создавал unit-файл для systemd, чтобы Nginx Exporter работал как служба.**

---

### 3. **Кому вы устанавливали Nginx Exporter?**

**Пример ответа:**
"Я устанавливал Nginx Exporter на:

- **Серверы Nginx**: для мониторинга их производительности в production.
- **Команды DevOps/SRE**: для отслеживания состояния серверов и настройки алертов.
- **Команды разработчиков**: для анализа производительности их приложений, работающих за Nginx (например, время обработки запросов)."

---

### 4. **Какие каверзные вопросы могут возникнуть и как на них ответить?**

#### Вопрос: Как вы решали проблемы с производительностью Nginx Exporter?
**Ответ:**
"Если возникали проблемы с производительностью, я:

1. Оптимизировал конфигурацию Nginx, например, увеличивал лимиты на количество подключений (`worker_connections`).
2. Уменьшал частоту сбора данных через параметр `scrape_interval` в Prometheus.
3. Настроил логирование для диагностики проблем."

#### Вопрос: Как вы обеспечивали безопасность Nginx Exporter?
**Ответ:**
"Я ограничивал доступ к порту экспортера через firewall или настраивал reverse proxy (Nginx) с базовой аутентификацией. Также я ограничивал доступ к эндпоинту `/nginx_status`, разрешая только localhost."

#### Вопрос: Как вы решали проблему с большим количеством метрик?
**Ответ:**
"Если метрик было слишком много, я:

1. Отключал ненужные метрики через конфигурацию экспортера.
2. Фильтровал метрики в Prometheus, используя `relabel_configs`.
3. Использовал агрегацию данных в PromQL для уменьшения объёма информации."

#### Вопрос: Как вы настраивали мониторинг SSL/TLS в Nginx?
**Ответ:**
"Я добавлял метрики о состоянии SSL/TLS сертификатов через Blackbox Exporter. Например, я использовал запросы для отслеживания сроков действия сертификатов (`probe_ssl_earliest_cert_expiry`)."

---

### 5. **Пример успешного кейса использования Nginx Exporter**

**Пример ответа:**
"Однажды мы столкнулись с проблемой высокого времени ответа сервера Nginx. С помощью Nginx Exporter мы настроили мониторинг метрик, таких как `nginx_http_request_duration_seconds` и `nginx_connections_waiting`. Мы обнаружили, что во время пиковых нагрузок количество ожидающих подключений (`nginx_connections_waiting`) превышает допустимый порог. После оптимизации конфигурации Nginx (увеличение лимитов на подключения) время ответа значительно сократилось."

---

### 6. **Что ещё можно добавить?**

#### Интеграция с Prometheus и Grafana:
"Мы интегрировали Nginx Exporter с Prometheus для сбора метрик и с Grafana для визуализации. Это позволило нам создавать информативные дашборды с данными о производительности серверов Nginx."

#### Автоматизация установки:
"Для масштабирования я написал Ansible playbook для автоматической установки и настройки Nginx Exporter."

#### Мониторинг бизнес-метрик:
"Мы использовали Nginx Exporter для мониторинга ключевых бизнес-метрик, таких как количество HTTP-ошибок (например, `nginx_http_requests_total{status=~"5.."}`) и среднее время обработки запросов."


---

## **Технические вопросы по Nginx Exporter**

1. **Что такое Nginx Exporter и для чего он используется?**
   - Ответ: Nginx Exporter — это инструмент, который собирает метрики из веб-сервера Nginx и предоставляет их в формате, совместимом с Prometheus. Он используется для мониторинга производительности и состояния сервера Nginx.

2. **Какие метрики предоставляет Nginx Exporter?**
   - Ответ: Основные метрики включают:
     - `nginx_connections_active` — текущее количество активных подключений.
     - `nginx_requests_total` — общее количество обработанных запросов.
     - `nginx_connections_handled` — количество обработанных подключений.
     - `nginx_http_requests_total` — количество HTTP-запросов по статусам.

3. **Как настроить Nginx для работы с Nginx Exporter?**
   - Ответ: Необходимо включить модуль `stub_status` в конфигурации Nginx:
     ```nginx
     location /nginx_status {
         stub_status on;
         allow 127.0.0.1;
         deny all;
     }
     ```

4. **Как установить Nginx Exporter?**
   - Ответ: Установка через скачивание бинарного файла или Docker:
     ```bash
     docker run -d --name nginx-exporter -p 9113:9113 nginx/nginx-prometheus-exporter:latest -nginx.scrape-uri=http://localhost/nginx_status
     ```

5. **Как проверить работу Nginx Exporter?**
   - Ответ: Используйте команду:
     ```bash
     curl http://localhost:9113/metrics
     ```
     Она вернет метрики в формате Prometheus.

6. **Как интегрировать Nginx Exporter с Prometheus?**
   - Ответ: Добавьте таргет в конфигурацию Prometheus (`prometheus.yml`):
     ```yaml
     scrape_configs:
       - job_name: 'nginx'
         static_configs:
           - targets: ['localhost:9113']
     ```

7. **Как обеспечить безопасность Nginx Exporter?**
   - Ответ: Ограничьте доступ к порту экспортера через firewall или настройте reverse proxy (например, Nginx) с базовой аутентификацией.

8. **Как уменьшить нагрузку на сервер от Nginx Exporter?**
   - Ответ: Уменьшите частоту сбора данных через параметр `scrape_interval` в Prometheus или отключите ненужные метрики.

9. **Можно ли использовать Nginx Exporter для мониторинга SSL/TLS?**
   - Ответ: Нет, для этого используется Blackbox Exporter. Однако можно комбинировать оба инструмента.

10. **Как настроить автозапуск Nginx Exporter?**
    - Ответ: Создайте unit-файл для systemd:
      ```ini
      [Unit]
      Description=Nginx Exporter

      [Service]
      ExecStart=/usr/local/bin/nginx-prometheus-exporter -nginx.scrape-uri=http://localhost/nginx_status
      Restart=always

      [Install]
      WantedBy=multi-user.target
      ```

---

### **Технические вопросы по Nginx**

11. **Что такое Nginx и для чего он используется?**
    - Ответ: Nginx — это высокопроизводительный веб-сервер, который также может работать как обратный прокси, балансировщик нагрузки и HTTP-кэш.

12. **Как работает асинхронная архитектура Nginx?**
    - Ответ: Nginx использует event-driven архитектуру, где один процесс может обрабатывать множество соединений одновременно, что делает его эффективным для высоких нагрузок.

13. **Как настроить балансировку нагрузки в Nginx?**
    - Ответ: Используйте блок `upstream`:
      ```nginx
      upstream backend {
          server 192.168.1.101;
          server 192.168.1.102;
      }

      server {
          location / {
              proxy_pass http://backend;
          }
      }
      ```

14. **Какие алгоритмы балансировки поддерживает Nginx?**
    - Ответ: Round Robin (по умолчанию), `least_conn`, `ip_hash`, `hash`.

15. **Как настроить HTTPS в Nginx?**
    - Ответ: Настройте SSL-сертификаты:
      ```nginx
      server {
          listen 443 ssl;
          server_name example.com;

          ssl_certificate /path/to/cert.pem;
          ssl_certificate_key /path/to/key.pem;
      }
      ```

16. **Как защитить Nginx от DDoS-атак?**
    - Ответ: Используйте модули `limit_req` и `limit_conn`:
      ```nginx
      limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;

      server {
          location / {
              limit_req zone=one burst=5 nodelay;
          }
      }
      ```

17. **Как включить gzip-сжатие в Nginx?**
    - Ответ: Добавьте следующие строки в конфигурацию:
      ```nginx
      gzip on;
      gzip_types text/plain text/css application/json application/javascript;
      ```

18. **Как настроить кэширование в Nginx?**
    - Ответ: Используйте директивы `proxy_cache`:
      ```nginx
      proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g;
      server {
          location / {
              proxy_cache my_cache;
              proxy_pass http://backend;
          }
      }
      ```

19. **Как проверить корректность конфигурации Nginx?**
    - Ответ: Используйте команду:
      ```bash
      sudo nginx -t
      ```

20. **Как настроить логирование в Nginx?**
    - Ответ: Настройте формат логов и пути:
      ```nginx
      log_format custom '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
      access_log /var/log/nginx/access.log custom;
      error_log /var/log/nginx/error.log warn;
      ```

---

### **Дополнительные вопросы для продвинутого уровня**

#### **Nginx Exporter**
- Как вы решали проблемы с большим количеством метрик?
- Как интегрировать Nginx Exporter с Grafana?

#### **Nginx**
- Как настроить редирект с HTTP на HTTPS?
  - Ответ: Используйте правило:
    ```nginx
    server {
        listen 80;
        server_name example.com;
        return 301 https://$host$request_uri;
    }
    ```

- Как использовать Nginx для обслуживания статического контента?
  - Ответ: Настройте директорию для статики:
    ```nginx
    server {
        root /var/www/static;
        index index.html;

        location / {
            try_files $uri $uri/ =404;
        }
    }
    ```

- Как настроить health check для бэкенд-серверов?
  - Ответ: Используйте параметры `max_fails` и `fail_timeout`:
    ```nginx
    upstream backend {
        server 192.168.1.101 max_fails=3 fail_timeout=30s;
        server 192.168.1.102 max_fails=3 fail_timeout=30s;
    }
    ```

- Как ограничить доступ к определенным IP-адресам?
  - Ответ: Используйте директивы `allow` и `deny`:
    ```nginx
    location /admin {
        allow 192.168.1.0/24;
        deny all;
    }
    ```

