## **Метрики в Prometheus**

В **Prometheus** метрики используются для сбора и анализа данных о производительности, состоянии и работе систем. Они имеют строгую типизацию, что позволяет эффективно работать с ними при анализе и мониторинге. Рассмотрим основные виды и типы метрик в Prometheus.

### Форматы метрик 

**Prometheus text-based format** — это стандартный формат представления метрик, используемый в экосистеме Prometheus для обмена данными между различными компонентами. Этот формат является текстовым и ориентированным на строки (line-oriented). Каждая строка отделяется символом `\n` (перевод строки), а последняя строка должна также заканчиваться этим символом. 

Помимо **Prometheus text-based format**, существуют другие форматы:

1. **OpenMetrics**  
   OpenMetrics является стандартным форматом, разработанным на основе Prometheus text-based format, но с дополнительными возможностями и улучшениями для обеспечения большей совместимости между различными системами мониторинга. Этот формат также текстовый и поддерживается Prometheus начиная с версии 2.0.  
   Пример использования:  
   ```
   # HELP http_requests_total Total number of HTTP requests
   # TYPE http_requests_total counter
   http_requests_total{method="get",code="200"} 1024
   ```

2. **Prometheus Protobuf Format**  
   Это двоичный формат, основанный на протоколе Protocol Buffers (Protobuf). Он используется для более эффективной передачи больших объемов данных по сравнению с текстовым форматом. Хотя этот формат менее человечески читаемый, он более компактный и быстрый в обработке.  

3. **JSON Format**  
   Некоторые системы и экспортеры могут предоставлять метрики в формате JSON, который затем преобразуется в формат Prometheus. Однако это не является стандартным способом для Prometheus, и обычно такие данные требуют промежуточной обработки через специальные адаптеры или скрипты.  

### Сравнение форматов:
- **Prometheus text-based format**: Человечески читаемый, простой в реализации, широко используется для экспозиции метрик.
- **OpenMetrics**: Совместим с Prometheus text-based format, но более универсален и стандартизирован.
- **Prometheus Protobuf Format**: Более эффективен для передачи больших объемов данных, но менее удобен для ручного анализа.
- **JSON**: Используется реже для передачи метрик, но может применяться в специфических случаях с дополнительной обработкой.

---

### Prometheus поддерживает четыре основных типа метрик:

1. **Counter ([Счетчик](https://play.grafana.org/d/cL5pLH7Wz/stats-overview?orgId=1&from=now-1h&to=now&timezone=browser))**  
   - Представляет собой метрику, значение которой только увеличивается со временем или сбрасывается до нуля при перезапуске системы.
   - Используется для подсчета событий, таких как количество запросов, ошибок или обработанных данных.
   - Пример: `http_requests_total` — общее количество HTTP-запросов.

   **Характеристики:**
   - Значение всегда возрастает или остается неизменным.
   - Может быть использовано для расчета скорости изменений (rate).

   **Пример:**
   ```plaintext
   http_requests_total{method="GET", handler="/api"} 12345
   ```

2. **Gauge ([Индикатор](https://play.grafana.org/d/vmie2cmWz/bar-gauge?orgId=1&from=now-6h&to=now&timezone=utc&refresh=10s))**  
   - Представляет собой метрику, значение которой может увеличиваться или уменьшаться.
   - Используется для измерения состояний, таких как использование CPU, памяти, температура или количество активных процессов.
   - Пример: `cpu_usage_percent` — текущая загрузка CPU.

   **Характеристики:**
   - Значение может изменяться в любую сторону.
   - Подходит для отслеживания динамических показателей.

   **Пример:**
   ```plaintext
   temperature_celsius{sensor="thermometer"} 25.5
   ```

3. **Histogram ([Гистограмма](https://play.grafana.org/d/histogram_tests/histogram-examples?orgId=1&from=now-6h&to=now&timezone=utc))**  
   - Представляет собой метрику, которая группирует наблюдаемые значения в диапазоны (buckets).
   - Используется для измерения распределения значений, например, времени выполнения запросов или размеров ответов.
   - Пример: `request_duration_seconds` — время выполнения HTTP-запросов.

   **Характеристики:**
   - Состоит из нескольких бакетов (диапазонов) и счетчика общего количества наблюдений (`_sum` и `_count`).
   - Позволяет рассчитывать процентили и средние значения.

   **Пример:**
   ```plaintext
   request_duration_seconds_bucket{le="0.1"} 120
   request_duration_seconds_bucket{le="0.5"} 300
   request_duration_seconds_bucket{le="1.0"} 450
   request_duration_seconds_sum 500.0
   request_duration_seconds_count 500
   ```

4. **Summary ([Сводка](https://play.grafana.org/d/000000052/advanced-layout?orgId=1&from=now-3h&to=now&timezone=browser))**  
   - Представляет собой метрику, которая вычисляет агрегированные значения, такие как среднее, медиана или процентили.
   - Используется для подсчета статистики по наблюдаемым данным.
   - Пример: `response_size_bytes` — размер ответов сервера.

   **Характеристики:**
   - Содержит заранее вычисленные процентили и суммарное количество наблюдений.
   - Менее гибкий, чем гистограммы, но более эффективный для некоторых случаев использования.

   **Пример:**
   ```plaintext
   response_size_bytes{quantile="0.5"} 1234
   response_size_bytes{quantile="0.9"} 2345
   response_size_bytes_sum 500000
   response_size_bytes_count 1000
   ```

---

### **Разница между Histogram и Summary**

| Характеристика         | Histogram                              | Summary                                |
|------------------------|----------------------------------------|----------------------------------------|
| Бакеты                 | Есть (диапазоны значений)              | Нет                                    |
| Процентили             | Вычисляются на клиенте или сервере     | Вычисляются заранее на клиенте         |
| Гибкость               | Можно агрегировать данные на сервере    | Нельзя агрегировать данные на сервере   |
| Использование          | Для анализа распределения значений      | Для предварительно вычисленной статистики |

---

В Prometheus каждый тип метрики имеет свои особенности и области применения:
- **Counter** используется для подсчета событий.
- **Gauge** применяется для измерения динамических показателей.
- **Histogram** и **Summary** подходят для анализа распределения данных.
