## Лейблы (Labels)

**Лейбл (Label)** — это пара ключ-значение, добавляющая контекст к метрике. Например, метрика `http_requests_total` может иметь лейблы `method="POST"`, `path="/api"`, `status_code="200"`, что позволяет группировать и фильтровать данные.

   ### Как используются лейблы в PromQL?
   
   - Фильтрация:  
     `http_requests_total{status="500"}`         # Выведет только 500-ые статусы по лейблу **status**
   - Группировка:  
     `sum by (method) (http_requests_total)`     # Отсортирует сумму по лейблу **method** каждого HTTP запроса
   - Агрегация:  
     `rate(http_requests_total{job="api"}[5m])`  # Cчитает прирост значения метрики за последние 5 минут при обращении к лейблу **job**

**Relabel_config** в Prometheus — это механизм для изменения или фильтрации меток (labels) целевых объектов (targets) во время сбора метрик. Он позволяет модифицировать, добавлять или удалять метки перед тем, как они будут использованы для группировки данных или хранения в базе Prometheus.

---

## Relabel_config

### Основная цель **relabel_config**:
1. **Фильтрация таргетов (целей)**: Исключить ненужные или неактуальные цели из процесса скрапинга.
2. **Модификация лейблов (меток)**: Изменить или переименовать существующие метки.
3. **Добавление новых лейблов**: Создать дополнительные метки на основе значений других меток.
4. **Управление маршрутизацией**: Настроить, какие метки будут использоваться для определения правил маршрутизации и агрегации.

---

### Как работает **relabel_config**?

Когда Prometheus получает список таргетов (например, через файл статических конфигураций или сервис-дискавери), каждая цель проходит через несколько этапов обработки, включая relabeling. Этот процесс выполняется последовательно, и результат одного шага становится входными данными для следующего.

#### Основные параметры **relabel_config**:

1. **`source_labels`**:
   - Указывает, какие лейблы должны быть использованы в качестве источника для преобразования.
   - Например: `source_labels: [__address__]`.

2. **`target_label`**:
   - Указывает таргет, который будет создан или изменен.
   - Например: `target_label: instance`.

3. **`regex`**:
   - [Регулярное выражение](https://habr.com/ru/articles/545150/ "Регулярные выражения (regexp) — основы."), которое применяется к значениям лейблов из `source_labels`.
   - По умолчанию используется `(?.*)`, что означает "любое значение".

4. **`replacement`**:
   - Значение, которым будет заменено совпадение регулярного выражения.
   - Может содержать обратные ссылки на (capturing group) группы захвата из `regex` (например, `$1`).

5. **`action`**:
   - Определяет, что делать с лейблами (метками):
     - `replace`: Заменяет значение лейбла (по умолчанию).
     - `keep`: Оставляет только те таргеты (цели), которые соответствуют `regex`.
     - `drop`: Удаляет таргеты, которые соответствуют `regex`.
     - `labelmap`: Применяет `regex` ко всем лейблам и создает новые лейблы.
     - `labeldrop`: Удаляет лейблы, чьи имена соответствуют `regex`.
     - `labelkeep`: Сохраняет только лейблы, чьи имена соответствуют `regex`.

---

### Пример использования **relabel_config**

#### 1. Простая замена лейбла:
Если вы хотите переименовать лейбл `__address__` в `instance`:
```yaml
relabel_configs:
  - source_labels: [__address__]
    target_label: instance
    replacement: $1
```

#### 2. Фильтрация таргетов (целей):
Если вы хотите собирать данные только с таргетов, чьи адреса начинаются с `localhost`:
```yaml
relabel_configs:
  - source_labels: [__address__]
    regex: localhost:.*
    action: keep
```

#### 3. Добавление новой метки:
Если вы хотите добавить лейбл `environment` со значением `production`:
```yaml
relabel_configs:
  - target_label: environment
    replacement: production
```

#### 4. Извлечение части строки:
Если адрес таргетов (целей) имеет формат `host:port` и вы хотите сохранить только имя хоста:
```yaml
relabel_configs:
  - source_labels: [__address__]
    target_label: instance
    regex: ([^:]+):.*
    replacement: $1
```

---

### Порядок выполнения

Нужно помнить, что правила `relabel_config` выполняются **в том порядке, в котором они указаны**. Поэтому порядок правил может влиять на результат.

---

### Зачем нужен **relabel_config**?

1. **Стандартизация лейблов (меток)**: Обеспечивает единообразие в именах лейблов и их значениях.
2. **Оптимизация скрейпинга (процесс регулярного сбора метрик Прометеусом)**: Исключает ненужные таргеты (цели), что снижает нагрузку на систему.
3. **Гибкость**: Позволяет адаптировать лейблы под конкретные требования мониторинга.
